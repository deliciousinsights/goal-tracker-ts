<!DOCTYPE html><html lang="en"><head><title>settings/SettingsScreen</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="settings/SettingsScreen"><meta name="groc-project-path" content="src/settings/SettingsScreen.tsx"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/settings/SettingsScreen.tsx</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="paramtres">Paramètres</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">import</span> { Link } from <span class="hljs-string">'react-router-dom'</span>
<span class="hljs-keyword">import</span> { useEffect, useState } from <span class="hljs-string">'react'</span>

<span class="hljs-keyword">import</span> Add from <span class="hljs-string">'@mui/icons-material/Add'</span>
<span class="hljs-keyword">import</span> ArrowBack from <span class="hljs-string">'@mui/icons-material/ArrowBack'</span>
<span class="hljs-keyword">import</span> Button from <span class="hljs-string">'@mui/material/Button'</span>
<span class="hljs-keyword">import</span> Card from <span class="hljs-string">'@mui/material/Card'</span>
<span class="hljs-keyword">import</span> CardActions from <span class="hljs-string">'@mui/material/CardActions'</span>
<span class="hljs-keyword">import</span> CardContent from <span class="hljs-string">'@mui/material/CardContent'</span>
<span class="hljs-keyword">import</span> CardHeader from <span class="hljs-string">'@mui/material/CardHeader'</span>
<span class="hljs-keyword">import</span> Divider from <span class="hljs-string">'@mui/material/Divider'</span>
<span class="hljs-keyword">import</span> IconButton from <span class="hljs-string">'@mui/material/IconButton'</span>
<span class="hljs-keyword">import</span> List from <span class="hljs-string">'@mui/material/List'</span>
<span class="hljs-keyword">import</span> ListItem from <span class="hljs-string">'@mui/material/ListItem'</span>
<span class="hljs-keyword">import</span> ListItemSecondaryAction from <span class="hljs-string">'@mui/material/ListItemSecondaryAction'</span>
<span class="hljs-keyword">import</span> ListItemText from <span class="hljs-string">'@mui/material/ListItemText'</span>
<span class="hljs-keyword">import</span> Logout from <span class="hljs-string">'@mui/icons-material/ExitToApp'</span>
<span class="hljs-keyword">import</span> Typography from <span class="hljs-string">'@mui/material/Typography'</span>

<span class="hljs-keyword">import</span> { addGoal, removeGoal, updateGoal } from <span class="hljs-string">'../reducers/goals'</span>
<span class="hljs-keyword">import</span> AddSettingDialog from <span class="hljs-string">'./AddSettingDialog'</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { ASDState } from <span class="hljs-string">'./AddSettingDialog'</span>
<span class="hljs-keyword">import</span> DeleteSettingDialog from <span class="hljs-string">'./DeleteSettingDialog'</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { Goal } from <span class="hljs-string">'../reducers/goals'</span>
<span class="hljs-keyword">import</span> GoalSetting from <span class="hljs-string">'./GoalSetting'</span>
<span class="hljs-keyword">import</span> { logOut } from <span class="hljs-string">'../reducers/currentUser'</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { RootState } from <span class="hljs-string">'../store'</span>
<span class="hljs-keyword">import</span> { useAppDispatch, useAppSelector } from <span class="hljs-string">'../store'</span>

<span class="hljs-keyword">const</span> DEFAULT_STATE: {
  goal: Goal | {}
  dialog: <span class="hljs-string">'delete'</span> | <span class="hljs-string">'add-or-update'</span> | <span class="hljs-literal">null</span>
} = {
  goal: {},
  dialog: <span class="hljs-literal">null</span>,
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SettingsScreen</span>(<span class="hljs-params"></span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Au premier rendu, on ajuste le titre du document pour permettre un
historique de navigation utilisable (et pas une tonne de titres
identiques).  Le <a href="https://fr.reactjs.org/docs/hooks-reference.html#conditionally-firing-an-effect">deuxième
argument</a>
est le tableau de dépendances qui indique quand relancer l’effet : comme il
est vide, seul le premier rendu du composant est concerné.</p></div></div><div class="code"><div class="wrapper">  useEffect(() =&gt; {
    <span class="hljs-built_in">document</span>.title = <span class="hljs-string">'Mes paramètres'</span>
  }, [])

  <span class="hljs-keyword">const</span> [{ goal, dialog }, setState] = useState(DEFAULT_STATE)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On s’intéresse uniquement aux champs <code>goals</code> et <code>currentUser.email</code> de
l’état global, qu’on veut retrouver dans nos propriétés sous les mêmes
noms.  Par ricochet, seuls les changements apportés à ces champs
entraîneront un éventuel <em>re-render</em> de notre conteneur.  La fonction
<code>selectState</code>, qui va chercher ces infos, est plus bas dans le fichier.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">const</span> { goals, email } = useAppSelector(selectState)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Vu qu’on va solliciter le <em>store</em> pour déclencher la déconnexion ou
manipuler les objectifs, on a besoin de <code>dispatch</code> afin de lui envoyer une
action.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">const</span> dispatch = useAppDispatch()

  <span class="hljs-keyword">return</span> (</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Quand on fait un bouton destiné à être en fait un lien, surtout au sein
d’un <a href="https://reacttraining.com/react-router/web/api/Link"><code>&lt;Link&gt;</code></a>, on
utilise la propriété
<a href="https://material-ui.com/api/button/#props"><code>component</code></a> pour altérer le
composant représentant la couche extérieure du bouton (en lieu et place
de <code>button</code>).  Les <em>props</em> non utilisées par <code>Button</code> sont alors passées
telles quelles à ce composant (ici la <em>prop</em> <code>to</code>).</p></div></div><div class="code"><div class="wrapper">    &lt;&gt;
      &lt;Button component={Link} startIcon={&lt;ArrowBack /&gt;} to=<span class="hljs-string">'/'</span> variant=<span class="hljs-string">'text'</span>&gt;
        Retour
      &lt;<span class="hljs-regexp">/Button&gt;
      &lt;Card className='settings'&gt;
        &lt;CardHeader title='Paramètres' /</span>&gt;
        &lt;CardContent&gt;
          &lt;List&gt;
            &lt;ListItem&gt;
              &lt;ListItemText
                primary=<span class="hljs-string">'Vous êtes connecté-e en tant que'</span>
                secondary={email}
              /&gt;
              &lt;ListItemSecondaryAction&gt;
                &lt;IconButton onClick={() =&gt; dispatch(logOut())}&gt;
                  &lt;Logout /&gt;
                &lt;<span class="hljs-regexp">/IconButton&gt;
              &lt;/</span>ListItemSecondaryAction&gt;
            &lt;<span class="hljs-regexp">/ListItem&gt;
          &lt;/</span>List&gt;
          &lt;Divider /&gt;
          &lt;List&gt;
            &lt;Typography variant=<span class="hljs-string">'subtitle1'</span>&gt;Mes objectifs&lt;<span class="hljs-regexp">/Typography&gt;
            {goals.map((goal) =&gt; (
              &lt;GoalSetting
                goal={goal}
                key={goal.id}
                onDeleteClick={openGoalDeleter}
                onEditClick={openGoalEditor}
              /</span>&gt;
            ))}
            {goals.length === <span class="hljs-number">0</span> &amp;&amp; (
              &lt;ListItem&gt;
                &lt;ListItemText secondary=<span class="hljs-string">'Aucun objectif pour le moment'</span> /&gt;
              &lt;<span class="hljs-regexp">/ListItem&gt;
            )}
          &lt;/</span>List&gt;
        &lt;<span class="hljs-regexp">/CardContent&gt;
        &lt;CardActions&gt;
          &lt;Button
            color='primary'
            onClick={openGoalAdder}
            startIcon={&lt;Add /</span>&gt;}
            variant=<span class="hljs-string">'contained'</span>
          &gt;
            Ajouter un objectif
          &lt;<span class="hljs-regexp">/Button&gt;
        &lt;/</span>CardActions&gt;
      &lt;<span class="hljs-regexp">/Card&gt;
      &lt;AddSettingDialog
        goal={goal}
        key={'id' in goal ? goal.id : null}
        onAdd={addOrUpdateGoal}
        onCancel={closeDialogs}
        onClosed={resetGoal}
        open={dialog === 'add-or-update'}
      /</span>&gt;
      &lt;DeleteSettingDialog
        goal={goal}
        onCancel={closeDialogs}
        onClosed={resetGoal}
        onDelete={deleteSelectedGoal}
        open={dialog === <span class="hljs-string">'delete'</span>}
      /&gt;
    &lt;<span class="hljs-regexp">/&gt;
  )
</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Ce callback n&#39;étant pas <em>inlined</em>, TS ne peut garantir son type d&#39;argument
de façon certaine, on type donc explicitement.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addOrUpdateGoal</span>(<span class="hljs-params">{ id, name, target, units, keepOpen }: ASDState</span>) </span>{
    <span class="hljs-keyword">if</span> (id !== <span class="hljs-literal">undefined</span>) {
      dispatch(updateGoal({ id, name, target, units }))
      keepOpen = <span class="hljs-literal">false</span>
    } <span class="hljs-keyword">else</span> {
      dispatch(addGoal({ name, target, units }))
    }
    <span class="hljs-keyword">if</span> (!keepOpen) {
      closeDialogs()
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">closeDialogs</span>(<span class="hljs-params"></span>) </span>{
    setState({ goal, dialog: <span class="hljs-literal">null</span> })
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">deleteSelectedGoal</span>(<span class="hljs-params"></span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>goal</code> pouvant être selon le cas <code>{}</code> ou un <code>Goal</code>, on doit rétrécir le
typage pour pouvoir accéder à <code>id</code> (on sait que cette fonction n&#39;est
appelée qu&#39;alors que <code>goal</code> est bien un objectif rempli.)</p></div></div><div class="code"><div class="wrapper">    dispatch(removeGoal({ id: (goal as Goal).id }))
    closeDialogs()
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">openGoalAdder</span>(<span class="hljs-params"></span>) </span>{
    setState({ goal: {}, dialog: <span class="hljs-string">'add-or-update'</span> })
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">openGoalDeleter</span>(<span class="hljs-params">goal: Goal</span>) </span>{
    setState({ goal, dialog: <span class="hljs-string">'delete'</span> })
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">openGoalEditor</span>(<span class="hljs-params">goal: Goal</span>) </span>{
    setState({ goal, dialog: <span class="hljs-string">'add-or-update'</span> })
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resetGoal</span>(<span class="hljs-params"></span>) </span>{
    setState(DEFAULT_STATE)
  }
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Fonction de sélection des valeurs utiles au composant au sein de l’état
global applicatif géré par Redux.  L’argument est l’état global applicatif
dans son intégralité, la valeur de retour sera celle renvoyée par le
<a href="https://react-redux.js.org/api/hooks#useselector"><code>useSelector()</code></a> auquel on
aura passé cette fonction.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">selectState</span>(<span class="hljs-params">{ goals, currentUser }: RootState</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Afin de respecter le typage (<code>UserInfo</code>), on ne peut pas se contenter de
lire <code>currentUser.email</code> et récupérer <code>undefined</code> lorsqu&#39;on n&#39;est pas
logués, comme en JS classique : il faut un <em>type guard</em> en amont de l&#39;accès
au champ.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">const</span> email =
    currentUser.loginState === <span class="hljs-string">'logged-in'</span> ? currentUser.email : <span class="hljs-literal">null</span>
  <span class="hljs-keyword">return</span> { goals, email }
}</div></div></div></div></body></html>