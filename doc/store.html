<!DOCTYPE html><html lang="en"><head><title>store</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="store"><meta name="groc-project-path" content="src/store.ts"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/store.ts</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="tat-applicatif">État applicatif</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">import</span> { configureStore } from <span class="hljs-string">'@reduxjs/toolkit'</span>
<span class="hljs-keyword">import</span> { offline } from <span class="hljs-string">'@redux-offline/redux-offline'</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { StoreEnhancer } from <span class="hljs-string">'@reduxjs/toolkit'</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { TypedUseSelectorHook } from <span class="hljs-string">'react-redux'</span>
<span class="hljs-keyword">import</span> { useDispatch, useSelector } from <span class="hljs-string">'react-redux'</span>

<span class="hljs-keyword">import</span> DEFAULT_STATE from <span class="hljs-string">'./default-state'</span>
<span class="hljs-keyword">import</span> goalTrackerReducer from <span class="hljs-string">'./reducers'</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { RootState } from <span class="hljs-string">'./reducers'</span>

<span class="hljs-keyword">export</span> { RootState }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Définition de l&#39;état par défaut (hors hydratation).  En production, on
partira sur un état vide, tous les réducteurs de tranches Redux posant alors
leurs valeurs par défaut granulaires.</p>
<p>L&#39;import statique de <code>DEFAULT_STATE</code>, plutôt qu&#39;un import dynamique, peut
sembler ajouter du poids au bundle, mais en réalité c&#39;est préférable : non
seulemment le ternaire ci-dessous va s&#39;inliner en <code>{}</code> dans un build de
production, entraînant <em>de facto</em> la purge de l&#39;import lors de l&#39;élimination
de code mort, mais en prime il évite un <em>code splitting</em> superflu en
développement.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">const</span> state = (
  process.env.NODE_ENV === <span class="hljs-string">'production'</span> ? {} : DEFAULT_STATE
) as RootState</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Cet export nous permet de construire facilement un <em>store</em> selon nos besoins
(et notamment un état initial précis), par exemple lors des tests ou dans
Storybook.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">makeStore</span>(<span class="hljs-params">
  preloadedState = state,
  { shouldPersist = process.env.NODE_ENV !== 'test' } = {}
</span>) </span>{
  <span class="hljs-keyword">const</span> store = configureStore({
    preloadedState,
    reducer: goalTrackerReducer,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Le typage de redux-offline n&#39;est pas au cordeau, un affinage par
annotation de type est nécessaire.</p></div></div><div class="code"><div class="wrapper">    enhancers: shouldPersist ? [offline({}) as StoreEnhancer] : [],
  })</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Gestion du HMR sur les réducteurs pendant le développement.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (process.env.NODE_ENV !== <span class="hljs-string">'production'</span> &amp;&amp; <span class="hljs-module"><span class="hljs-keyword">module</span>.hot) </span>{
    <span class="hljs-module"><span class="hljs-keyword">module</span>.hot.accept('./reducers', () =&gt;
      store.replaceReducer(goalTrackerReducer)
    )
  }

  return store
}
</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Création de l&#39;état par défaut (pour le dev et la prod principalement, les tests
et Storybook créeraient les leurs sur-mesure selon leurs besoins.)</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">const</span> store = makeStore()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Enrobage
<a href="https://react-redux.js.org/using-react-redux/usage-with-typescript#define-typed-hooks">recommandé</a>,
pour des questions de typage automatique, des hooks de base <code>useDispatch</code> et
<code>useSelector</code>, afin notamment de s&#39;épargner du typage explicite pour les
sélecteurs <em>inline</em>.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">type</span> AppDispatch = <span class="hljs-keyword">typeof</span> store.dispatch

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useAppDispatch: () =&gt; AppDispatch = useDispatch
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useAppSelector: TypedUseSelectorHook&lt;RootState&gt; = useSelector</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Le store pour le dev / la prod est l&#39;export par défaut.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> store</div></div></div></div></body></html>