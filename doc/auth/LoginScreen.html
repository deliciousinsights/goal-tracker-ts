<!DOCTYPE html><html lang="en"><head><title>auth/LoginScreen</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="auth/LoginScreen"><meta name="groc-project-path" content="src/auth/LoginScreen.tsx"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/auth/LoginScreen.tsx</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="cran-de-connexion">Écran de connexion</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { FormEvent } from <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { useEffect, useState } from <span class="hljs-string">'react'</span>

<span class="hljs-keyword">import</span> ArrowForward from <span class="hljs-string">'@mui/icons-material/ArrowForward'</span>
<span class="hljs-keyword">import</span> Button from <span class="hljs-string">'@mui/material/Button'</span>
<span class="hljs-keyword">import</span> Card from <span class="hljs-string">'@mui/material/Card'</span>
<span class="hljs-keyword">import</span> CardActions from <span class="hljs-string">'@mui/material/CardActions'</span>
<span class="hljs-keyword">import</span> CardContent from <span class="hljs-string">'@mui/material/CardContent'</span>
<span class="hljs-keyword">import</span> CardHeader from <span class="hljs-string">'@mui/material/CardHeader'</span>
<span class="hljs-keyword">import</span> Snackbar from <span class="hljs-string">'@mui/material/Snackbar'</span>
<span class="hljs-keyword">import</span> TextField from <span class="hljs-string">'@mui/material/TextField'</span>

<span class="hljs-keyword">import</span> classes from <span class="hljs-string">'./LoginScreen.module.css'</span>
<span class="hljs-keyword">import</span> { logIn } from <span class="hljs-string">'../reducers/currentUser'</span>
<span class="hljs-keyword">import</span> TogglablePasswordField from <span class="hljs-string">'./TogglablePasswordField'</span>
<span class="hljs-keyword">import</span> { useAppDispatch, useAppSelector } from <span class="hljs-string">'../store'</span>

<span class="hljs-keyword">const</span> MIN_PASSWORD_LENGTH = <span class="hljs-number">6</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">LoginScreen</span>(<span class="hljs-params"></span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Au premier rendu, on ajuste le titre du document pour permettre un
historique de navigation utilisable (et pas une tonne de titres
identiques).  Le <a href="https://fr.reactjs.org/docs/hooks-reference.html#conditionally-firing-an-effect">deuxième
argument</a>
est le tableau de dépendances qui indique quand relancer l’effet : comme il
est vide, seul le premier rendu du composant est concerné.</p></div></div><div class="code"><div class="wrapper">  useEffect(() =&gt; {
    <span class="hljs-built_in">document</span>.title = <span class="hljs-string">'Identifiez-vous'</span>
  }, [])</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On utilise des champs contrôlés pour les valeurs, afin de récupérer
facilement leurs valeurs courantes dans le code de lancement de la
connexion.  Il est important d’avoir une <code>String</code> comme valeur par défaut
(par opposition à, disons, <code>undefined</code> ou <code>null</code>) afin que le champ soit
contrôlé d’entrée de jeu.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">const</span> [email, setEmail] = useState(<span class="hljs-string">''</span>)
  <span class="hljs-keyword">const</span> [password, setPassword] = useState(<span class="hljs-string">''</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Récupération des infos qui nous intéressent depuis l’état global applicatif
géré par Redux. En l’occurrence, seul <code>currentUser.loginState</code> nous
intéresse.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">const</span> loginState = useAppSelector((state) =&gt; state.currentUser.loginState)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Vu qu’on va solliciter le <em>store</em> pour déclencher la connexion, on a besoin
de <code>dispatch</code> afin de lui envoyer une action.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">const</span> dispatch = useAppDispatch()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On définit quelques flags et éléments variables de notre UI suivant l’étape
de login en cours : délogué, login en cours, login réussi, login échoué.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">const</span> loggingIn = loginState === <span class="hljs-string">'pending'</span>
  <span class="hljs-keyword">const</span> logInIcon = loggingIn ? <span class="hljs-literal">null</span> : &lt;ArrowForward /&gt;
  <span class="hljs-keyword">const</span> canLogIn =
    !loggingIn &amp;&amp; email !== <span class="hljs-string">''</span> &amp;&amp; password.trim().length &gt;= MIN_PASSWORD_LENGTH</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>En cas d’échec explicite, une
<em><a href="https://material-ui.com/components/snackbars/">snackbar</a></em> apparaîtra 2s
en bas de la fenêtre, pour nous signifier le souci.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">const</span> snackBar =
    loginState === <span class="hljs-string">'failure'</span> ? (
      &lt;Snackbar message=<span class="hljs-string">'Identifiant ou mot de passe invalide'</span> open /&gt;
    ) : (
      <span class="hljs-string">''</span>
    )

  <span class="hljs-keyword">return</span> (
    &lt;form onSubmit={handleSubmit}&gt;
      &lt;Card className={classes.loginScreen}&gt;
        &lt;CardHeader title=<span class="hljs-string">'Goal Tracker'</span> subheader=<span class="hljs-string">'Connexion'</span> /&gt;
        &lt;CardContent&gt;
          &lt;TextField
            autoComplete=<span class="hljs-string">'home email'</span>
            id=<span class="hljs-string">'email'</span>
            name=<span class="hljs-string">'email'</span>
            label=<span class="hljs-string">'E-mail'</span>
            fullWidth
            margin=<span class="hljs-string">'normal'</span>
            onChange={(event) =&gt; setEmail(normalizeEmail(event.target.value))}
            placeholder=<span class="hljs-string">'mon@email.tld'</span>
            required
            <span class="hljs-keyword">type</span>=<span class="hljs-string">'email'</span>
            value={email}
          /&gt;
          &lt;TogglablePasswordField
            autoComplete=<span class="hljs-string">'current-password'</span>
            helperText={`${MIN_PASSWORD_LENGTH} caractères minimum`}
            id=<span class="hljs-string">'password'</span>
            name=<span class="hljs-string">'password'</span>
            label=<span class="hljs-string">'Mot de passe'</span>
            fullWidth
            margin=<span class="hljs-string">'normal'</span>
            onChange={(event) =&gt; setPassword(event.target.value)}
            placeholder=<span class="hljs-string">'super mot de passe'</span>
            required
            value={password}
          /&gt;
        &lt;<span class="hljs-regexp">/CardContent&gt;
        &lt;CardActions style={{ display: 'flex', justifyContent: 'center' }}&gt;
          &lt;Button
            color='primary'
            disabled={!canLogIn}
            startIcon={logInIcon}
            type='submit'
            variant='contained'
          &gt;
            Connecte-toi
          &lt;/</span>Button&gt;
        &lt;<span class="hljs-regexp">/CardActions&gt;
      &lt;/</span>Card&gt;
      {snackBar}
    &lt;<span class="hljs-regexp">/form&gt;
  )
</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Gestionnaire d’envoi du formulaire, pour déclencher plutôt une connexion
via appel API.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleSubmit</span>(<span class="hljs-params">event: FormEvent</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On commence par empêcher le traitement par défaut de l&#39;événement
<code>submit</code>, qui déclencherait un envoi du formulaire au serveur.  Et <strong>non,
on n’utilise pas <code>return false</code></strong>, qui est une extension jQuery qui, en
plus, appellerait stopPropagation(), ce qui n’est pas souhaitable (et ne
marche pas sans jQuery).</p></div></div><div class="code"><div class="wrapper">    event.preventDefault()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Hop, on sollicite le <em>store</em> Redux de façon appropriée, avec le bon
<em>action creator</em>.</p></div></div><div class="code"><div class="wrapper">    dispatch(logIn({ email, password }))
  }
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Petit utilitaire de normalisation d&#39;adresse e-mail, utilisé à la volée lors
de la saisie (champ contrôlé).</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">normalizeEmail</span>(<span class="hljs-params">email: <span class="hljs-built_in">string</span></span>) </span>{
  <span class="hljs-keyword">return</span> email
    .replace(<span class="hljs-regexp">/\s+/g</span>, <span class="hljs-string">''</span>)
    .replace(<span class="hljs-regexp">/^[^@]+/</span>, (text) =&gt; text.toLowerCase())
}</div></div></div></div></body></html>